const { spawn } = require('child_process');
const path = require('path');
const fs = require('fs');

// Ruta al ejecutable FreeRDP y carpeta de DLLs
const FREERDP_DIR = path.join(__dirname, '../resources/freerdp');
const FREERDP_EXE = path.join(FREERDP_DIR, 'wfreerdp.exe');

// Almac√©n de procesos RDP activos
const activeRdpSessions = new Map();

/**
 * Verifica que el ejecutable FreeRDP est√© disponible
 */
function checkFreeRDPAvailable() {
  if (!fs.existsSync(FREERDP_EXE)) {
    throw new Error(`FreeRDP no encontrado en: ${FREERDP_EXE}`);
  }
  return true;
}

/**
 * Inicia una nueva sesi√≥n RDP
 * @param {Object} config - Configuraci√≥n de la sesi√≥n RDP
 * @param {string} config.host - Host/IP del servidor RDP
 * @param {string} config.user - Usuario
 * @param {string} config.password - Contrase√±a
 * @param {number} config.port - Puerto (por defecto 3389)
 * @param {number} config.width - Ancho de pantalla (por defecto 1280)
 * @param {number} config.height - Alto de pantalla (por defecto 800)
 * @param {string} config.sessionId - ID √∫nico de la sesi√≥n
 */
function startRdpSession(config) {
  checkFreeRDPAvailable();

  const {
    host,
    user,
    password,
    port = 3389,
    width = 1280,
    height = 800,
    sessionId = `rdp_${Date.now()}`
  } = config;

  // Verificar si ya existe una sesi√≥n con este ID
  if (activeRdpSessions.has(sessionId)) {
    throw new Error(`La sesi√≥n ${sessionId} ya est√° activa`);
  }

  // Construir argumentos para wfreerdp.exe
  const args = [
    `/v:${host}:${port}`,
    `/u:${user}`,
    `/p:${password}`,
    `/size:${width}x${height}`,
    `/cert:ignore`,
    `/compression`,
    `/clipboard`,
    '/audio-mode:0', // Desactivar audio por defecto
    '/gdi:hw', // Usar aceleraci√≥n hardware si est√° disponible
    '+auto-reconnect', // Reconexi√≥n autom√°tica
    '/auto-reconnect-max-retries:3'
  ];

  console.log(`üöÄ Iniciando sesi√≥n RDP: ${sessionId} -> ${user}@${host}:${port}`);

  // Spawning del proceso FreeRDP
  const rdpProcess = spawn(FREERDP_EXE, args, {
    cwd: FREERDP_DIR, // Importante: working directory donde est√°n las DLLs
    stdio: ['pipe', 'pipe', 'pipe'], // stdin, stdout, stderr
    windowsHide: false, // Mostrar la ventana RDP
    detached: false // No detached para poder manejar el proceso
  });

  // Configurar handlers del proceso
  rdpProcess.on('spawn', () => {
    console.log(`‚úÖ Sesi√≥n RDP ${sessionId} iniciada (PID: ${rdpProcess.pid})`);
  });

  rdpProcess.on('close', (code, signal) => {
    console.log(`üîö Sesi√≥n RDP ${sessionId} terminada - Code: ${code}, Signal: ${signal}`);
    activeRdpSessions.delete(sessionId);
    
    // Callback opcional para notificar al UI
    if (config.onClose) {
      config.onClose(sessionId, code, signal);
    }
  });

  rdpProcess.on('error', (error) => {
    console.error(`‚ùå Error en sesi√≥n RDP ${sessionId}:`, error);
    activeRdpSessions.delete(sessionId);
    
    // Callback opcional para notificar errores al UI
    if (config.onError) {
      config.onError(sessionId, error);
    }
  });

  // Capturar stdout/stderr para logs (opcional)
  rdpProcess.stdout.on('data', (data) => {
    console.log(`[${sessionId}] STDOUT:`, data.toString());
  });

  rdpProcess.stderr.on('data', (data) => {
    console.error(`[${sessionId}] STDERR:`, data.toString());
  });

  // Almacenar la sesi√≥n activa
  activeRdpSessions.set(sessionId, {
    process: rdpProcess,
    config: { ...config, sessionId },
    startTime: new Date(),
    pid: rdpProcess.pid
  });

  return {
    sessionId,
    pid: rdpProcess.pid,
    config: { host, user, port, width, height }
  };
}

/**
 * Detiene una sesi√≥n RDP espec√≠fica
 * @param {string} sessionId - ID de la sesi√≥n a detener
 */
function stopRdpSession(sessionId) {
  const session = activeRdpSessions.get(sessionId);
  
  if (!session) {
    throw new Error(`Sesi√≥n ${sessionId} no encontrada`);
  }

  console.log(`üõë Deteniendo sesi√≥n RDP: ${sessionId}`);
  
  try {
    // Intentar cerrar graciosamente
    session.process.kill('SIGTERM');
    
    // Si no se cierra en 3 segundos, forzar cierre
    setTimeout(() => {
      if (!session.process.killed) {
        console.log(`‚ö° Forzando cierre de sesi√≥n ${sessionId}`);
        session.process.kill('SIGKILL');
      }
    }, 3000);
    
  } catch (error) {
    console.error(`Error al detener sesi√≥n ${sessionId}:`, error);
    throw error;
  }
}

/**
 * Detiene todas las sesiones RDP activas
 */
function stopAllRdpSessions() {
  console.log(`üõë Deteniendo todas las sesiones RDP (${activeRdpSessions.size})`);
  
  for (const sessionId of activeRdpSessions.keys()) {
    try {
      stopRdpSession(sessionId);
    } catch (error) {
      console.error(`Error al detener sesi√≥n ${sessionId}:`, error);
    }
  }
}

/**
 * Obtiene informaci√≥n de las sesiones activas
 */
function getActiveSessions() {
  const sessions = [];
  
  for (const [sessionId, session] of activeRdpSessions.entries()) {
    sessions.push({
      sessionId,
      pid: session.pid,
      startTime: session.startTime,
      config: session.config,
      uptime: Date.now() - session.startTime.getTime()
    });
  }
  
  return sessions;
}

/**
 * Verifica si una sesi√≥n espec√≠fica est√° activa
 */
function isSessionActive(sessionId) {
  return activeRdpSessions.has(sessionId);
}

module.exports = {
  startRdpSession,
  stopRdpSession,
  stopAllRdpSessions,
  getActiveSessions,
  isSessionActive,
  checkFreeRDPAvailable
}; 